---
Test
---
<test page>

!define TEST_SYSTEM {slim}
!path   ./CognitiveCitiesTesting.jar

'''Include Variable Definitions'''

!include <IocSuite.IocServicesSuite.SetUpVariables

'''Create i18n resources for the data source'''

| generic service validator fixture |
| requestType | serviceName | requestBody | customHeaders | getResponseCode? | getResponseMessage? | getResponseId? | getResultCount? | getUrl? |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_DsLabel", "value":"Database Table Test (Fitnesse)","messages": []} | | | | | | |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_ID", "value":"ID","messages": []} | | | | | | |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_LASTCHANGED", "value":"LASTCHANGED","messages": []} | | | | | | |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_LOCATION", "value":"LOCATION","messages": []} | | | | | | |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_NAME", "value":"NAME","messages": []} | | | | | | |
| POST | /i18n-service/resources | {"group": "Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_STARTDATETIME", "value":"STARTDATETIME","messages": []} | | | | | | |

'''CREATE DATABASE TYPE DATASOURCES'''

'''Create database table for the data source'''

| generic database fixture |
| # comment | connectionName | statementType | statementText | responseFormat | getResponse? | getResultCount? | getResponseMessage? |
| Create source database table | iocdb | create | CREATE TABLE ioc.ds_source_table (ID INTEGER NOT NULL, NAME VARCHAR(128) NOT NULL, STARTDATETIME TIMESTAMP, LOCATION VARCHAR(500), LASTCHANGED TIMESTAMP) ORGANIZE BY ROW DATA CAPTURE NONE IN USERSPACE1 | | | | OK |
| Insert first record | iocdb | create | insert into ioc.ds_source_table values (1,'NAME1','2019-04-01 12:00:00.0','POINT(-97.69575 30.590381)','2019-04-03 12:00:00.0') | | | | OK |
| Insert second record | iocdb | create | insert into ioc.ds_source_table values (2,'NAME2','2019-04-02 13:00:00.0','POINT(-97.69675 30.590481)','2019-04-03 13:00:00.0') | | | | OK |
| Verify the records were created | iocdb | read | select count as count from ioc.ds_source_table | json | [{"COUNT":2}] | 1 | OK |

'''Create database type data source '''

| generic service validator fixture |
| requestType | serviceName | requestBody | customHeaders | getResponseCode? | getResponseMessage? | getResponseId? | getResultCount? | getUrl? |
| POST | /datasource-service/datasources/ | { "name":"db_table_test", "messages":[ { "messageId":"CIYRS0008I", "messageText":"{\"key\":\"CIYRS0008I\",\"group\":\"DataSourceApp\"}", "i18nMessageText":"The data source Database Table Test was saved." } ], "type":"Database", "scope":"DATASOURCE", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_DsLabel", "resources":[ { "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_DsLabel", "value":"Database Table Test (Fitnesse)" } ] }, "i18nLabel":"Database Table Test (Fitnesse)", "description":{ "group":"Fitnesse", "key":"i18n_d565a122-1b46-48db-8651-c370f6967137", "resources":[ { "group":"Fitnesse", "locale":"en", "key":"i18n_d565a122-1b46-48db-8651-c370f6967137", "value":"" } ] }, "receiver":{ "type":"com.ibm.ioc.datareceiver.types.DataReceiverTable", "interval":1, "unit":"MINUTES", "started":true, "skippedColumns":[ ] }, "source":{ "protocol":"ioc.datasource.ColumnParserDatabase", "options":"DB2", "host":"${DBSERVER}", "port":${DBPORT}, "user":"${DBUSER}", "password":"${DBPASSWORD}", "directory":"iocdb", "filename":"ioc.ds_source_table" }, "columns":[ { "type":"INTEGER", "sourceType":"INTEGER", "sourceName":"ID", "hint":"ID", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_ID", "i18nLabel":"ID", "resources":[ { "id":83315, "lastUpdateDate":1554313063902, "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_ID", "value":"ID" } ] }, "category":"KEY", "length":"10", "scale":"0", "enumerated":false, "isId":true, "optimize":true, "updatable":false, "metric":false, "chart":false, "hidden":false, "ordinal":0, "hover":false, "previewCard":true, "helpMessage":{ "group":"Fitnesse", "key":"i18n_65345362-d788-493a-9c5f-c5a2f704b7e1", "i18nLabel":"", "resources":[ { "id":83316, "lastUpdateDate":1554313063905, "group":"Fitnesse", "locale":"en", "key":"i18n_65345362-d788-493a-9c5f-c5a2f704b7e1", "value":"" } ] }, "userFilterInput":false, "displayedonMap":false, "targetNames":[ "Property_ID" ] }, { "type":"TIMESTAMP", "sourceType":"TIMESTAMP", "sourceName":"LASTCHANGED", "hint":"LASTCHANGED", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_LASTCHANGED", "i18nLabel":"LASTCHANGED", "resources":[ { "id":83323, "lastUpdateDate":1554313063928, "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_LASTCHANGED", "value":"LASTCHANGED" } ] }, "category":"MINIMAL", "length":"26", "scale":"6", "enumerated":false, "isId":false, "optimize":false, "updatable":true, "metric":false, "chart":false, "hidden":false, "ordinal":0, "hover":false, "previewCard":true, "helpMessage":{ "group":"Fitnesse", "key":"i18n_2400baef-9fbc-4890-b0eb-6304e55085d2", "i18nLabel":"", "resources":[ { "id":83324, "lastUpdateDate":1554313063932, "group":"Fitnesse", "locale":"en", "key":"i18n_2400baef-9fbc-4890-b0eb-6304e55085d2", "value":"" } ] }, "userFilterInput":false, "displayedonMap":false, "targetNames":[ "LAST_UPDATE_DATE_TIME" ], "format":"TIMESTAMP" }, { "type":"VARCHAR", "sourceType":"VARCHAR", "sourceName":"LOCATION", "hint":"LOCATION", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_LOCATION", "i18nLabel":"LOCATION", "resources":[ { "id":83321, "lastUpdateDate":1554313063921, "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_LOCATION", "value":"LOCATION" } ] }, "category":"MINIMAL", "length":"500", "scale":"0", "enumerated":false, "isId":false, "optimize":false, "updatable":true, "metric":false, "chart":false, "hidden":false, "ordinal":0, "hover":false, "previewCard":true, "helpMessage":{ "group":"Fitnesse", "key":"i18n_76d7a203-16af-413f-873b-ac9cca8ad5bf", "i18nLabel":"", "resources":[ { "id":83322, "lastUpdateDate":1554313063925, "group":"Fitnesse", "locale":"en", "key":"i18n_76d7a203-16af-413f-873b-ac9cca8ad5bf", "value":"" } ] }, "userFilterInput":false, "displayedonMap":false, "targetNames":[ "LOCATION" ], "format":"SHAPE", "lookup":{ "directory":"", "filename":"" } }, { "type":"VARCHAR", "sourceType":"VARCHAR", "sourceName":"NAME", "hint":"NAME", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_NAME", "i18nLabel":"NAME", "resources":[ { "id":83317, "lastUpdateDate":1554313063909, "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_NAME", "value":"NAME" } ] }, "category":"MINIMAL", "length":"128", "scale":"0", "enumerated":false, "isId":false, "optimize":false, "updatable":true, "metric":false, "chart":false, "hidden":false, "ordinal":0, "hover":false, "previewCard":true, "helpMessage":{ "group":"Fitnesse", "key":"i18n_d400529c-b6e0-413f-8cf4-e4468d62f8ba", "i18nLabel":"", "resources":[ { "id":83318, "lastUpdateDate":1554313063912, "group":"Fitnesse", "locale":"en", "key":"i18n_d400529c-b6e0-413f-8cf4-e4468d62f8ba", "value":"" } ] }, "userFilterInput":false, "displayedonMap":false, "targetNames":[ "NAME" ], "format":"STRING" }, { "type":"TIMESTAMP", "sourceType":"TIMESTAMP", "sourceName":"STARTDATETIME", "hint":"STARTDATETIME", "label":{ "group":"Fitnesse", "key":"DbDatasource_Fitnesse_STARTDATETIME", "i18nLabel":"STARTDATETIME", "resources":[ { "id":83319, "lastUpdateDate":1554313063915, "group":"Fitnesse", "locale":"en", "key":"DbDatasource_Fitnesse_STARTDATETIME", "value":"STARTDATETIME" } ] }, "category":"MINIMAL", "length":"26", "scale":"6", "enumerated":false, "isId":false, "optimize":false, "updatable":true, "metric":false, "chart":false, "hidden":false, "ordinal":0, "hover":false, "previewCard":true, "helpMessage":{ "group":"Fitnesse", "key":"i18n_a58fbc7f-dee7-4adc-807d-1339553775b9", "i18nLabel":"", "resources":[ { "id":83320, "lastUpdateDate":1554313063918, "group":"Fitnesse", "locale":"en", "key":"i18n_a58fbc7f-dee7-4adc-807d-1339553775b9", "value":"" } ] }, "userFilterInput":false, "displayedonMap":false, "targetNames":[ "START_DATE_TIME" ], "format":"TIMESTAMP" } ], "geometry":"POINT", "archive":0, "boundary":false, "boundaryFilterPane":false, "correlation":false, "report":false, "serverRendering":false, "nonTrustedSource":false, "comments":false, "voting":false, "imageUploads":false, "icon":"311.png", "radius":0, "sides":0, "styles":[ { "name":"_base_", "type":"COLOR", "line":"#000000", "value":"#d3d3d3", "weight":1, "opacity":1, "scope":"DATASOURCE" } ], "extensions":[ { "name":"category", "label":{ }, "type":"CUSTOM", "disabled":false, "multiple":false, "module":"ICPO", "associated":"1" }, { "name":"dimension", "label":{ }, "type":"CUSTOM", "disabled":false, "multiple":false, "module":"ICPO", "associated":"false" }, { "name":"name", "label":{ }, "type":"CUSTOM", "disabled":false, "multiple":false, "module":"ICPO", "associated":"db_table_test" }, { "name":"resource", "label":{ }, "type":"CUSTOM", "disabled":false, "multiple":false, "module":"ICPO", "associated":"false" } ], "customProperties":{ }, "optionalDateTime":false, "minZoomForLoad":0, "dateFormat":"", "timeFormat":"", "areas":"", "routingLogic":"AND", "rules":[ ]} | | 200 | | $DSID_DB= | | |
| GET | /datasource-service/datasources/$DSID_DB | | | 200 | =~/(?i)"name":"db_table_test"/ | | 1 | |

| script |
| #''Give data receiver time to receive records'' |
| time delay ; | 5000 |

'''Verify the target table has the correct number of records'''

| generic database fixture |
| connectionName | statementType | statementText | responseFormat | getResponse? | getResultCount? | getResponseMessage? | getFirstResultField? |
| iocdata | read | select count as count from ioc.target_table_db_table_test | json | [{"COUNT":2}] | 1 | OK | 2 |
