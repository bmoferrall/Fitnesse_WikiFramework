---
Test
---
<test page>

!define TEST_SYSTEM {slim}
!path   ./CognitiveCitiesTesting.jar

'''Include Variable Definitions'''

!include <IocSuite.IocServicesSuite.SetUpVariables


'''CREATE CSV DATASOURCES'''

'''Copy source csv to app server '''

|script                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|remote file copy;|./testfiles/datasource_init.csv|/opt/IBM/ioc/csv/names.csv|${APPSERVER}|${APPSERVERUSER}|${APPSERVERKEYFILE}|${APPSERVERKEYPWD}|

'''Create CSV type data source '''

|generic service validator fixture                                                                                                                                                  |
|requestType|serviceName                                                                                               |requestBody|customHeaders|getResponseCode?|getResponseMessage?|getResponseId?|getResultCount?|getUrl?|
|POST        |/datasource-service/datasources/     | {"name":"csv_test","lastUpdateDate":1554453178886,"messages":[{"messageId":"CIYRS0008I","messageText":"{\"key\":\"CIYRS0008I\",\"group\":\"DataSourceApp\"}","i18nMessageText":"The data source CSV Test was saved."}],"type":"CSV","scope":"DATASOURCE","label":{"group":"DataSourceI18n","key":"i18n_6aaa21cf-57f4-4c65-8c3b-53e2b14ccc55","resources":[{"group":"DataSourceI18n","locale":"en","key":"i18n_6aaa21cf-57f4-4c65-8c3b-53e2b14ccc55","value":"CSV Test"}]},"i18nLabel":"CSV Test","description":{"group":"DataSourceI18n","key":"i18n_5ba0ce4d-0897-41c4-8350-c1c09d72f64d","resources":[{"group":"DataSourceI18n","locale":"en","key":"i18n_5ba0ce4d-0897-41c4-8350-c1c09d72f64d","value":""}]},"receiver":{"type":"com.ibm.ioc.datareceiver.types.DataReceiverCSV","interval":1,"unit":"MINUTES","started":false,"skippedColumns":[]},"source":{"protocol":"ioc.datasource.ColumnParserCsv","directory":"/opt/IBM/ioc/csv/","filename":"names.csv"},"columns":[{"type":"INTEGER","sourceType":"VARCHAR","sourceName":"0","hint":"ID","label":{"group":"DataSourceI18n","key":"8601acf4-c867-46a8-b5f9-f19ca5ca36fe","i18nLabel":"ID","resources":[{"id":83844,"lastUpdateDate":1554453179461,"group":"DataSourceI18n","locale":"en","key":"8601acf4-c867-46a8-b5f9-f19ca5ca36fe","value":"ID"}]},"category":"KEY","enumerated":false,"isId":true,"optimize":true,"updatable":false,"metric":false,"chart":false,"hidden":false,"ordinal":0,"hover":false,"previewCard":true,"helpMessage":{"group":"DataSourceI18n","key":"7edb532a-02e8-468a-850b-93ef682b6368","i18nLabel":"","resources":[{"id":83845,"lastUpdateDate":1554453179479,"group":"DataSourceI18n","locale":"en","key":"7edb532a-02e8-468a-850b-93ef682b6368","value":""}]},"userFilterInput":false,"displayedonMap":false,"targetNames":["Property_ID"]},{"type":"TIMESTAMP","sourceType":"VARCHAR","sourceName":"4","hint":"LASTCHANGED","label":{"group":"DataSourceI18n","key":"fed4e75c-b9ba-484d-bb68-16b0209d8b7c","i18nLabel":"LASTCHANGED","resources":[{"id":83852,"lastUpdateDate":1554453179518,"group":"DataSourceI18n","locale":"en","key":"fed4e75c-b9ba-484d-bb68-16b0209d8b7c","value":"LASTCHANGED"}]},"category":"MINIMAL","enumerated":false,"isId":false,"optimize":false,"updatable":true,"metric":false,"chart":false,"hidden":false,"ordinal":0,"hover":false,"previewCard":true,"helpMessage":{"group":"DataSourceI18n","key":"9b0aa82e-b255-4597-a02d-718e81178b22","i18nLabel":"","resources":[{"id":83853,"lastUpdateDate":1554453179532,"group":"DataSourceI18n","locale":"en","key":"9b0aa82e-b255-4597-a02d-718e81178b22","value":""}]},"userFilterInput":false,"displayedonMap":false,"targetNames":["LAST_UPDATE_DATE_TIME"],"format":"TIMESTAMP"},{"type":"VARCHAR","sourceType":"VARCHAR","sourceName":"3","hint":"LOCATION","label":{"group":"DataSourceI18n","key":"02dd0c55-3dbf-4750-a80a-0883ee42a664","i18nLabel":"LOCATION","resources":[{"id":83850,"lastUpdateDate":1554453179507,"group":"DataSourceI18n","locale":"en","key":"02dd0c55-3dbf-4750-a80a-0883ee42a664","value":"LOCATION"}]},"category":"MINIMAL","enumerated":false,"isId":false,"optimize":false,"updatable":true,"metric":false,"chart":false,"hidden":false,"ordinal":0,"hover":false,"previewCard":true,"helpMessage":{"group":"DataSourceI18n","key":"743d7523-f3df-45e3-a993-2200a109a830","i18nLabel":"","resources":[{"id":83851,"lastUpdateDate":1554453179513,"group":"DataSourceI18n","locale":"en","key":"743d7523-f3df-45e3-a993-2200a109a830","value":""}]},"userFilterInput":false,"displayedonMap":false,"targetNames":["LOCATION"],"format":"SHAPE","lookup":{"directory":"","filename":""}},{"type":"VARCHAR","sourceType":"VARCHAR","sourceName":"1","hint":"NAME","label":{"group":"DataSourceI18n","key":"16cdcd63-4759-4402-bfe7-61195acd51e4","i18nLabel":"NAME","resources":[{"id":83846,"lastUpdateDate":1554453179487,"group":"DataSourceI18n","locale":"en","key":"16cdcd63-4759-4402-bfe7-61195acd51e4","value":"NAME"}]},"category":"MINIMAL","enumerated":false,"isId":false,"optimize":false,"updatable":true,"metric":false,"chart":false,"hidden":false,"ordinal":0,"hover":false,"previewCard":true,"helpMessage":{"group":"DataSourceI18n","key":"0da1a12b-8418-4895-9af3-f93cb9d1dd77","i18nLabel":"","resources":[{"id":83847,"lastUpdateDate":1554453179492,"group":"DataSourceI18n","locale":"en","key":"0da1a12b-8418-4895-9af3-f93cb9d1dd77","value":""}]},"userFilterInput":false,"displayedonMap":false,"targetNames":["NAME"],"format":"STRING"},{"type":"TIMESTAMP","sourceType":"VARCHAR","sourceName":"2","hint":"STARTDATETIME","label":{"group":"DataSourceI18n","key":"9dcb1dc9-2a4e-4397-8935-e96558463af3","i18nLabel":"STARTDATETIME","resources":[{"id":83848,"lastUpdateDate":1554453179497,"group":"DataSourceI18n","locale":"en","key":"9dcb1dc9-2a4e-4397-8935-e96558463af3","value":"STARTDATETIME"}]},"category":"MINIMAL","enumerated":false,"isId":false,"optimize":false,"updatable":true,"metric":false,"chart":false,"hidden":false,"ordinal":0,"hover":false,"previewCard":true,"helpMessage":{"group":"DataSourceI18n","key":"35f33e3d-2c69-44b6-b6c6-9962a5dc2a9d","i18nLabel":"","resources":[{"id":83849,"lastUpdateDate":1554453179502,"group":"DataSourceI18n","locale":"en","key":"35f33e3d-2c69-44b6-b6c6-9962a5dc2a9d","value":""}]},"userFilterInput":false,"displayedonMap":false,"targetNames":["START_DATE_TIME"],"format":"TIMESTAMP"}],"geometry":"POINT","archive":0,"boundary":false,"boundaryFilterPane":false,"correlation":false,"report":false,"serverRendering":false,"nonTrustedSource":false,"comments":false,"voting":false,"imageUploads":false,"icon":"311.png","radius":0,"sides":0,"styles":[{"name":"_base_","type":"COLOR","line":"#000000","value":"#d3d3d3","weight":1,"opacity":1,"scope":"DATASOURCE"}],"extensions":[{"name":"category","label":{},"type":"CUSTOM","disabled":false,"multiple":false,"module":"ICPO","associated":"1"},{"name":"dimension","label":{},"type":"CUSTOM","disabled":false,"multiple":false,"module":"ICPO","associated":"false"},{"name":"name","label":{},"type":"CUSTOM","disabled":false,"multiple":false,"module":"ICPO","associated":"csv_test"},{"name":"resource","label":{},"type":"CUSTOM","disabled":false,"multiple":false,"module":"ICPO","associated":"false"}],"customProperties":{},"optionalDateTime":false,"minZoomForLoad":0,"dateFormat":"","timeFormat":"","areas":"","routingLogic":"AND","rules":[]}       ||200||$DSID_CSV=|||
|GET        |/datasource-service/datasources/$DSID_CSV |||200             |=~/(?i)"Name":"csv_test"/||1||

|script                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|#''Give data receiver time to receive records''|
|time delay ;|3000|

'''Verify the target table has two records'''

|generic database fixture                                                                                                                                                                                                        |
|# comment|connectionName|statementType|statementText                                                                                                       |responseFormat|getResponse?               |getResultCount?|getResponseMessage?|
|Verify the target table has two records|iocdata           |read         |select count as count from ioc.target_table_csv_test      |json          |[{"COUNT":2}]              |1              |OK                 |
